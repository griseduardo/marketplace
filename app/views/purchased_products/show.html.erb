<h1>Dados da negociação</h1>

<dl>
  <dt><%= PurchasedProduct.human_attribute_name(:profile) %></dt>
  <% if @purchased_product.profile.chosen_name.present? %>
    <dd><%= @purchased_product.profile.chosen_name %></dd>
  <% else %>
    <dd><%= @purchased_product.profile.full_name %></dd>
  <% end %>
  <dt><%= PurchasedProduct.human_attribute_name(:total_quantity) %></dt>
  <dd><%= @purchased_product.total_quantity %></dd>
  <dt><%= PurchasedProduct.human_attribute_name(:initial_value) %></dt>
  <dd><%= number_to_currency @purchased_product.initial_value %></dd>
  <dt><%= PurchasedProduct.human_attribute_name(:start_date) %></dt>
  <dd><%= l @purchased_product.start_date %></dd>
</dl>

<% if @purchased_product.andamento? %>
  <h2>Negociação</h2>
  <% @purchased_product.negotiations.each do |negotiation| %>
    <div>
      <strong>Nome:</strong>
      <% if negotiation.profile.chosen_name.blank? %>
        <%= negotiation.profile.full_name %>  
      <% else %>  
        <%= negotiation.profile.chosen_name %>
      <% end %>
    </div>
    <div>
      <strong>Departamento:</strong> 
      <%= negotiation.profile.department.name %>
    </div>
    <div>
      <strong>Mensagem:</strong> 
      <%= negotiation.negotiation_message %>
    </div>
  <% end %>

  <h2>Enviar mensagem:</h2>
  <%= form_with(model: [ @purchased_product, @purchased_product.negotiations.build ], local: true) do |f| %>
    <p>
      <%= f.label :negotiation_message %>
      <%= f.text_field :negotiation_message %>
    </p>
    <p>
      <%= f.submit 'Enviar mensagem' %>
    </p>
  <% end %>
<% end %>

<% if @purchased_product.iniciada? && current_user == @product.profile.user %>
  <h2>Aprovar venda</h2>
  <%= link_to 'Recusar venda', refuse_product_purchased_product_path(@product, @purchased_product), method: :post %>
  <%= link_to 'Confirmar venda', confirm_product_purchased_product_path(@product, @purchased_product), method: :post %>
<% end %>

<% if @purchased_product.iniciada? && current_user != @product.profile.user %>
  <h2>Aguardando aprovação do vendedor</h2>
<% end %>

<% if @purchased_product.recusada? && current_user == @product.profile.user %>
  <h2>Venda recusada</h2>
  <%= PurchasedProduct.human_attribute_name(:end_date) %>
  <%= l @purchased_product.end_date %>

  <h2>Dúvidas e respostas</h2>
  <% @purchased_product.product.questions.each do |question| %>
    <% if question.profile == @purchased_product.profile %>
      <div>
        <h3>Pergunta</h3>
        <strong>Nome:</strong>
        <% if question.profile.chosen_name.blank? %>
          <%= question.profile.full_name %>  
        <% else %>  
          <%= question.profile.chosen_name %>
        <% end %>
      </div>
      <div>
        <strong>Departamento:</strong> 
        <%= question.profile.department.name %>
      </div>
      <div>
        <strong>Dúvida:</strong> 
        <%= question.question_message %>
      </div>

      <% if question.answer %>
        <div>
          <h3>Resposta</h3>
          <strong>Nome:</strong>
          <% if @product.profile.chosen_name.blank? %>
            <%= @product.profile.full_name %>  
          <% else %>  
            <%= @product.profile.chosen_name %>
          <% end %>
        </div>
        <div>
          <strong>Departamento:</strong> 
          <%= @product.profile.department.name %>
        </div>
        <div>
          <strong>Resposta:</strong> 
          <%= question.answer.answer_message %>
        </div>
      <% end %>      
    <% end %>
  <% end %>  
<% end %>

<% if @purchased_product.recusada? && current_user != @product.profile.user %>
  <h2>Compra recusada</h2>
  <%= PurchasedProduct.human_attribute_name(:end_date) %>
  <%= l @purchased_product.end_date %>

  <h2>Dúvidas e respostas</h2>
  <% @purchased_product.product.questions.each do |question| %>
    <% if question.profile == @purchased_product.profile %>
      <div>
        <h3>Pergunta</h3>
        <strong>Nome:</strong>
        <% if question.profile.chosen_name.blank? %>
          <%= question.profile.full_name %>  
        <% else %>  
          <%= question.profile.chosen_name %>
        <% end %>
      </div>
      <div>
        <strong>Departamento:</strong> 
        <%= question.profile.department.name %>
      </div>
      <div>
        <strong>Dúvida:</strong> 
        <%= question.question_message %>
      </div>

      <% if question.answer %>
        <div>
          <h3>Resposta</h3>
          <strong>Nome:</strong>
          <% if @product.profile.chosen_name.blank? %>
            <%= @product.profile.full_name %>  
          <% else %>  
            <%= @product.profile.chosen_name %>
          <% end %>
        </div>
        <div>
          <strong>Departamento:</strong> 
          <%= @product.profile.department.name %>
        </div>
        <div>
          <strong>Resposta:</strong> 
          <%= question.answer.answer_message %>
        </div>
      <% end %>      
    <% end %>
  <% end %>  
<% end %>

<% if @purchased_product.andamento? && current_user == @product.profile.user %>
  <h2>Finalizar venda</h2>
  <%= link_to 'Cancelar venda', cancel_product_purchased_product_path(@product, @purchased_product), method: :post %>
<% end %>

<% if @purchased_product.cancelada? && current_user == @product.profile.user %>
  <h2>Venda cancelada</h2>
  <%= PurchasedProduct.human_attribute_name(:end_date) %>
  <%= l @purchased_product.end_date %>

  <h2>Negociação</h2>
  <% @purchased_product.negotiations.each do |negotiation| %>
    <div>
      <strong>Nome:</strong>
      <% if negotiation.profile.chosen_name.blank? %>
        <%= negotiation.profile.full_name %>  
      <% else %>  
        <%= negotiation.profile.chosen_name %>
      <% end %>
    </div>
    <div>
      <strong>Departamento:</strong> 
      <%= negotiation.profile.department.name %>
    </div>
    <div>
      <strong>Mensagem:</strong> 
      <%= negotiation.negotiation_message %>
    </div>
  <% end %>

  <h2>Dúvidas e respostas</h2>
  <% @purchased_product.product.questions.each do |question| %>
    <% if question.profile == @purchased_product.profile %>
      <div>
        <h3>Pergunta</h3>
        <strong>Nome:</strong>
        <% if question.profile.chosen_name.blank? %>
          <%= question.profile.full_name %>  
        <% else %>  
          <%= question.profile.chosen_name %>
        <% end %>
      </div>
      <div>
        <strong>Departamento:</strong> 
        <%= question.profile.department.name %>
      </div>
      <div>
        <strong>Dúvida:</strong> 
        <%= question.question_message %>
      </div>

      <% if question.answer %>
        <div>
          <h3>Resposta</h3>
          <strong>Nome:</strong>
          <% if @product.profile.chosen_name.blank? %>
            <%= @product.profile.full_name %>  
          <% else %>  
            <%= @product.profile.chosen_name %>
          <% end %>
        </div>
        <div>
          <strong>Departamento:</strong> 
          <%= @product.profile.department.name %>
        </div>
        <div>
          <strong>Resposta:</strong> 
          <%= question.answer.answer_message %>
        </div>
      <% end %>      
    <% end %>
  <% end %>
<% end %>

<% if @purchased_product.cancelada? && current_user != @product.profile.user %>
  <h2>Compra cancelada</h2>
  <%= PurchasedProduct.human_attribute_name(:end_date) %>
  <%= l @purchased_product.end_date %>

  <h2>Negociação</h2>
  <% @purchased_product.negotiations.each do |negotiation| %>
    <div>
      <strong>Nome:</strong>
      <% if negotiation.profile.chosen_name.blank? %>
        <%= negotiation.profile.full_name %>  
      <% else %>  
        <%= negotiation.profile.chosen_name %>
      <% end %>
    </div>
    <div>
      <strong>Departamento:</strong> 
      <%= negotiation.profile.department.name %>
    </div>
    <div>
      <strong>Mensagem:</strong> 
      <%= negotiation.negotiation_message %>
    </div>
  <% end %>

  <h2>Dúvidas e respostas</h2>
  <% @purchased_product.product.questions.each do |question| %>
    <% if question.profile == @purchased_product.profile %>
      <div>
        <h3>Pergunta</h3>
        <strong>Nome:</strong>
        <% if question.profile.chosen_name.blank? %>
          <%= question.profile.full_name %>  
        <% else %>  
          <%= question.profile.chosen_name %>
        <% end %>
      </div>
      <div>
        <strong>Departamento:</strong> 
        <%= question.profile.department.name %>
      </div>
      <div>
        <strong>Dúvida:</strong> 
        <%= question.question_message %>
      </div>

      <% if question.answer %>
        <div>
          <h3>Resposta</h3>
          <strong>Nome:</strong>
          <% if @product.profile.chosen_name.blank? %>
            <%= @product.profile.full_name %>  
          <% else %>  
            <%= @product.profile.chosen_name %>
          <% end %>
        </div>
        <div>
          <strong>Departamento:</strong> 
          <%= @product.profile.department.name %>
        </div>
        <div>
          <strong>Resposta:</strong> 
          <%= question.answer.answer_message %>
        </div>
      <% end %>      
    <% end %>
  <% end %>
<% end %>

<h1><%= @product.name %></h1>

<dl>
  <dt><%= Product.human_attribute_name(:profile) %></dt>
  <% if @product.profile.chosen_name.present? %>
    <dd><%= @product.profile.chosen_name %></dd>
  <% else %>
    <dd><%= @product.profile.full_name %></dd>
  <% end %>
  <dd><%= @product.profile.user.email %></dd>
  <dd><%= @product.profile.department.name %></dd>
  <dt><%= Product.human_attribute_name(:description) %></dt>
  <dd><%= @product.description %></dd>
  <dt>Categoria</dt>
  <dd><%= @product.product_subcategory.product_category.name %></dd>
  <dt><%= Product.human_attribute_name(:product_subcategory) %></dt>
  <dd><%= @product.product_subcategory.name %></dd>
  <dt><%= Product.human_attribute_name(:product_condition) %></dt>
  <dd><%= @product.product_condition.name %></dd>
</dl>

<% @product.images.each do |image| %>
  <%= image_tag image %>
<% end %>